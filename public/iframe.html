<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NotivIQ Iframe Host</title>
</head>
<body>
<script>
(function(){
  "use strict";

  // base64url -> Uint8Array
  function u8(b64url){
    var padding = "=".repeat((4 - (b64url.length % 4)) % 4);
    var b64 = (b64url + padding).replace(/-/g, "+").replace(/_/g, "/");
    var raw = atob(b64);
    var arr = new Uint8Array(raw.length);
    for (var i=0;i<raw.length;i++) arr[i] = raw.charCodeAt(i);
    return arr;
  }

  async function postJSON(url, body, headers){
    const res = await fetch(url, {
      method: "POST",
      headers: Object.assign({ "Content-Type": "application/json" }, headers || {}),
      body: JSON.stringify(body),
      cache: "no-store",
      credentials: "omit"
    });
    if (!res.ok) {
      let text = "";
      try { text = await res.text(); } catch {}
      throw new Error("HTTP " + res.status + (text ? (": "+text) : ""));
    }
    try { return await res.json(); } catch { return {}; }
  }

  window.addEventListener("message", async (ev) => {
    const data = ev.data || {};
    if (data.type !== "NOTIVIQ_REGISTER") return;

    const origin = ev.origin; // origem do parent
    const send = (payload) => ev.source && ev.source.postMessage(payload, origin);

    const api = String(data.api || "").replace(/\/$/, "");
    const headers = {};
    if (data.publishableKey) headers["X-NotivIQ-Key"] = data.publishableKey;

    try {
      // 1) Registrar SW neste origin do iframe
      const swUrl = "/sw.js?api=" + encodeURIComponent(api);
      const reg = await navigator.serviceWorker.register(swUrl);
      await navigator.serviceWorker.ready;

      // 2) Permissão
      const perm = await Notification.requestPermission();
      if (perm !== "granted") throw new Error("permission_denied");

      // 3) Subscription (reutiliza se já existir)
      const sub = (await reg.pushManager.getSubscription())
        || (await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: u8(data.vapid)
          }));

      // 4) POST /subscriptions
      const payload = {
        accountId: data.accountId,
        campaignId: data.campaignId || undefined,
        subscription: sub,
        tags: data.tags || [],
        locale: data.locale,
      };
      const result = await postJSON(api + "/subscriptions", payload, headers);

      // 5) Resposta ao parent
      send({
        type: "NOTIVIQ_REGISTER_RESULT",
        reqId: data.reqId,
        ok: true,
        payload: {
          id: result.id,
          endpoint: sub && sub.endpoint,
          accountId: data.accountId,
          campaignId: data.campaignId || undefined
        }
      });
    } catch (err) {
      send({
        type: "NOTIVIQ_REGISTER_RESULT",
        reqId: data.reqId,
        ok: false,
        error: (err && err.message) ? err.message : String(err)
      });
    }
  }, false);
})();
</script>
</body>
</html>
